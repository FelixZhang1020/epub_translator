{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Prompt Variable Schema",
  "description": "Shared schema for prompt template variables used by both frontend and backend",
  "version": "2.0.0",

  "stages": ["analysis", "translation", "optimization", "proofreading"],

  "categories": {
    "project": {
      "label": "Project",
      "labelZh": "项目",
      "description": "Static metadata from the ePub project",
      "icon": "BookOpen"
    },
    "content": {
      "label": "Content",
      "labelZh": "内容",
      "description": "Current paragraph or text being processed",
      "icon": "FileText"
    },
    "context": {
      "label": "Context",
      "labelZh": "上下文",
      "description": "Surrounding paragraphs for translation continuity",
      "icon": "Layers"
    },
    "pipeline": {
      "label": "Pipeline",
      "labelZh": "流水线",
      "description": "Output from previous processing steps",
      "icon": "GitBranch"
    },
    "derived": {
      "label": "Derived",
      "labelZh": "派生",
      "description": "Values extracted from analysis results",
      "icon": "Sparkles"
    },
    "meta": {
      "label": "Meta",
      "labelZh": "元数据",
      "description": "Runtime computed values",
      "icon": "Calculator"
    },
    "user": {
      "label": "Custom",
      "labelZh": "自定义",
      "description": "User-defined variables for project-specific needs",
      "icon": "User"
    }
  },

  "variables": [
    {
      "name": "title",
      "fullName": "project.title",
      "category": "project",
      "type": "string",
      "description": "Book title from ePub metadata",
      "descriptionZh": "ePub 元数据中的书名",
      "source": "project.epub_title",
      "stages": ["analysis", "translation", "optimization", "proofreading"],
      "example": "Knowing God"
    },
    {
      "name": "author",
      "fullName": "project.author",
      "category": "project",
      "type": "string",
      "description": "Author name from ePub metadata",
      "descriptionZh": "ePub 元数据中的作者名",
      "source": "project.epub_author",
      "stages": ["analysis", "translation", "optimization", "proofreading"],
      "example": "J.I. Packer"
    },
    {
      "name": "author_background",
      "fullName": "project.author_background",
      "category": "project",
      "type": "string",
      "description": "Custom author background information provided by user",
      "descriptionZh": "用户提供的作者背景资料",
      "source": "project.author_background",
      "stages": ["translation"],
      "example": "J.I. Packer (1926-2020) was a British-born Canadian evangelical theologian..."
    },
    {
      "name": "source_language",
      "fullName": "project.source_language",
      "category": "project",
      "type": "string",
      "description": "Source language of the book",
      "descriptionZh": "书籍的源语言",
      "source": "project.epub_language",
      "stages": ["analysis", "translation"],
      "example": "en"
    },
    {
      "name": "target_language",
      "fullName": "project.target_language",
      "category": "project",
      "type": "string",
      "description": "Target translation language",
      "descriptionZh": "翻译的目标语言",
      "source": "settings.target_language",
      "stages": ["translation", "optimization"],
      "example": "zh-CN"
    },
    {
      "name": "name",
      "fullName": "project.name",
      "category": "project",
      "type": "string",
      "description": "Project name (may differ from book title)",
      "descriptionZh": "项目名称（可能与书名不同）",
      "source": "project.name",
      "stages": ["analysis", "translation", "optimization", "proofreading"],
      "example": "knowing-god-translation"
    },
    {
      "name": "source",
      "fullName": "content.source",
      "category": "content",
      "type": "string",
      "description": "Source text to be translated (canonical name)",
      "descriptionZh": "待翻译的源文本（规范名称）",
      "source": "paragraph.source_text",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "The grace of God is infinite and eternal.",
      "required": true
    },
    {
      "name": "target",
      "fullName": "content.target",
      "category": "content",
      "type": "string",
      "description": "Current translation (canonical name)",
      "descriptionZh": "当前译文（规范名称）",
      "source": "paragraph.target_text",
      "stages": ["optimization", "proofreading"],
      "example": "神的恩典是无限而永恒的。"
    },
    {
      "name": "chapter_title",
      "fullName": "content.chapter_title",
      "category": "content",
      "type": "string",
      "description": "Title of the current chapter",
      "descriptionZh": "当前章节的标题",
      "source": "chapter.title",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "Chapter 1: Knowing and Being Known"
    },
    {
      "name": "source_text",
      "fullName": "content.source_text",
      "category": "content",
      "type": "string",
      "description": "Source text (legacy alias for content.source)",
      "descriptionZh": "源文本（content.source 的旧名称）",
      "source": "paragraph.source_text",
      "stages": ["translation", "optimization"],
      "canonicalName": "content.source",
      "isLegacy": true
    },
    {
      "name": "previous_source",
      "fullName": "context.previous_source",
      "category": "context",
      "type": "string",
      "description": "Previous paragraph source text",
      "descriptionZh": "上一段的源文本",
      "source": "context_window.before_source",
      "stages": ["translation"],
      "example": "In the previous chapter, we discussed..."
    },
    {
      "name": "previous_target",
      "fullName": "context.previous_target",
      "category": "context",
      "type": "string",
      "description": "Previous paragraph translation",
      "descriptionZh": "上一段的译文",
      "source": "context_window.before_target",
      "stages": ["translation"],
      "example": "在前一章中，我们讨论了..."
    },
    {
      "name": "reference_translation",
      "fullName": "pipeline.reference_translation",
      "category": "pipeline",
      "type": "string",
      "description": "Reference translation from existing sources",
      "descriptionZh": "来自现有来源的参考译文",
      "source": "reference_match.result",
      "stages": ["translation"],
      "example": "神的恩典是无穷无尽的。"
    },
    {
      "name": "suggested_changes",
      "fullName": "pipeline.suggested_changes",
      "category": "pipeline",
      "type": "string",
      "description": "User-confirmed suggestions for optimization",
      "descriptionZh": "用户确认的优化建议",
      "source": "proofreading_step.suggestions",
      "stages": ["optimization"],
      "example": "Change '无穷无尽' to '无限而永恒' for better accuracy."
    },
    {
      "name": "author_name",
      "fullName": "derived.author_name",
      "category": "derived",
      "type": "string",
      "description": "Author name extracted from analysis",
      "descriptionZh": "从分析结果中提取的作者名",
      "source": "analysis_result.author_name",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "J.I. Packer"
    },
    {
      "name": "author_biography",
      "fullName": "derived.author_biography",
      "category": "derived",
      "type": "string",
      "description": "Author biography extracted from analysis",
      "descriptionZh": "从分析结果中提取的作者简介",
      "source": "analysis_result.author_biography",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "British-born Canadian evangelical theologian (1926-2020)"
    },
    {
      "name": "writing_style",
      "fullName": "derived.writing_style",
      "category": "derived",
      "type": "string",
      "description": "Writing style extracted from analysis",
      "descriptionZh": "从分析结果中提取的写作风格",
      "source": "analysis_result.writing_style",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "Academic theological prose with pastoral warmth"
    },
    {
      "name": "tone",
      "fullName": "derived.tone",
      "category": "derived",
      "type": "string",
      "description": "Tone of the writing extracted from analysis",
      "descriptionZh": "从分析结果中提取的语气",
      "source": "analysis_result.tone",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "Reverent, instructive, encouraging"
    },
    {
      "name": "target_audience",
      "fullName": "derived.target_audience",
      "category": "derived",
      "type": "string",
      "description": "Target audience identified in analysis",
      "descriptionZh": "分析中识别的目标读者",
      "source": "analysis_result.target_audience",
      "stages": ["translation"],
      "example": "Seminary students and lay theologians"
    },
    {
      "name": "genre_conventions",
      "fullName": "derived.genre_conventions",
      "category": "derived",
      "type": "string",
      "description": "Genre conventions identified in analysis",
      "descriptionZh": "分析中识别的体裁惯例",
      "source": "analysis_result.genre_conventions",
      "stages": ["translation"],
      "example": "Systematic theology with scriptural exposition"
    },
    {
      "name": "terminology_table",
      "fullName": "derived.terminology_table",
      "category": "derived",
      "type": "terminology",
      "description": "Formatted terminology table from analysis",
      "descriptionZh": "从分析结果中提取的术语表（已格式化）",
      "source": "analysis_result.key_terminology (formatted)",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "- grace: 恩典\\n- covenant: 圣约\\n- redemption: 救赎"
    },
    {
      "name": "priority_order",
      "fullName": "derived.priority_order",
      "category": "derived",
      "type": "array",
      "description": "Translation priority order from analysis",
      "descriptionZh": "翻译优先级顺序",
      "source": "analysis_result.translation_principles.priority_order",
      "stages": ["translation"],
      "example": "[\"信\", \"达\", \"雅\"]",
      "structure": "string[]"
    },
    {
      "name": "faithfulness_boundary",
      "fullName": "derived.faithfulness_boundary",
      "category": "derived",
      "type": "string",
      "description": "Content that must be translated literally",
      "descriptionZh": "必须严格直译的内容",
      "source": "analysis_result.translation_principles.faithfulness_boundary",
      "stages": ["translation"],
      "example": "Technical terms, Scripture quotes, data"
    },
    {
      "name": "permissible_adaptation",
      "fullName": "derived.permissible_adaptation",
      "category": "derived",
      "type": "string",
      "description": "Areas where adaptation is allowed",
      "descriptionZh": "允许调整的范围",
      "source": "analysis_result.translation_principles.permissible_adaptation",
      "stages": ["translation"],
      "example": "Sentence restructuring, connector optimization"
    },
    {
      "name": "red_lines",
      "fullName": "derived.red_lines",
      "category": "derived",
      "type": "string",
      "description": "Prohibited translation behaviors",
      "descriptionZh": "翻译禁止项",
      "source": "analysis_result.translation_principles.red_lines",
      "stages": ["translation"],
      "example": "Adding commentary, omitting content, changing stance"
    },
    {
      "name": "style_constraints",
      "fullName": "derived.style_constraints",
      "category": "derived",
      "type": "string",
      "description": "Style and tone constraints from analysis",
      "descriptionZh": "从分析结果中提取的风格/语气约束",
      "source": "analysis_result.translation_principles.style_constraints",
      "stages": ["translation"],
      "example": "Avoid colloquialisms, maintain formal register"
    },
    {
      "name": "custom_guidelines",
      "fullName": "derived.custom_guidelines",
      "category": "derived",
      "type": "array",
      "description": "Custom translation guidelines from analysis",
      "descriptionZh": "从分析结果中提取的自定义翻译指引",
      "source": "analysis_result.custom_guidelines",
      "stages": ["translation"],
      "example": "[\"Always capitalize references to God\", \"Use traditional terms for sacraments\"]",
      "structure": "string[]"
    },

    {
      "name": "has_analysis",
      "fullName": "derived.has_analysis",
      "category": "derived",
      "type": "boolean",
      "description": "Whether analysis exists for this project",
      "descriptionZh": "项目是否已完成分析",
      "source": "computed",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "true"
    },
    {
      "name": "has_writing_style",
      "fullName": "derived.has_writing_style",
      "category": "derived",
      "type": "boolean",
      "description": "Whether writing style is defined",
      "descriptionZh": "是否定义了写作风格",
      "source": "computed",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "true"
    },
    {
      "name": "has_tone",
      "fullName": "derived.has_tone",
      "category": "derived",
      "type": "boolean",
      "description": "Whether tone is defined",
      "descriptionZh": "是否定义了语气",
      "source": "computed",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "true"
    },
    {
      "name": "has_terminology",
      "fullName": "derived.has_terminology",
      "category": "derived",
      "type": "boolean",
      "description": "Whether terminology table exists",
      "descriptionZh": "是否存在术语表",
      "source": "computed",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "true"
    },
    {
      "name": "has_target_audience",
      "fullName": "derived.has_target_audience",
      "category": "derived",
      "type": "boolean",
      "description": "Whether target audience is defined",
      "descriptionZh": "是否定义了目标读者",
      "source": "computed",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "true"
    },
    {
      "name": "has_genre_conventions",
      "fullName": "derived.has_genre_conventions",
      "category": "derived",
      "type": "boolean",
      "description": "Whether genre conventions are defined",
      "descriptionZh": "是否定义了体裁惯例",
      "source": "computed",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "true"
    },
    {
      "name": "has_translation_principles",
      "fullName": "derived.has_translation_principles",
      "category": "derived",
      "type": "boolean",
      "description": "Whether translation principles are defined",
      "descriptionZh": "是否定义了翻译原则",
      "source": "computed",
      "stages": ["translation"],
      "example": "true"
    },
    {
      "name": "has_custom_guidelines",
      "fullName": "derived.has_custom_guidelines",
      "category": "derived",
      "type": "boolean",
      "description": "Whether custom guidelines exist",
      "descriptionZh": "是否存在自定义指引",
      "source": "computed",
      "stages": ["translation"],
      "example": "false"
    },
    {
      "name": "has_style_constraints",
      "fullName": "derived.has_style_constraints",
      "category": "derived",
      "type": "boolean",
      "description": "Whether style constraints exist",
      "descriptionZh": "是否存在风格约束",
      "source": "computed",
      "stages": ["translation"],
      "example": "false"
    },
    {
      "name": "has_author_biography",
      "fullName": "derived.has_author_biography",
      "category": "derived",
      "type": "boolean",
      "description": "Whether author biography is defined",
      "descriptionZh": "是否定义了作者简介",
      "source": "computed",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "true"
    },
    {
      "name": "has_bible_policy",
      "fullName": "derived.has_bible_policy",
      "category": "derived",
      "type": "boolean",
      "description": "Whether Bible reference policy is defined",
      "descriptionZh": "是否定义了圣经引用策略",
      "source": "computed",
      "stages": ["translation"],
      "example": "false"
    },
    {
      "name": "book_title",
      "fullName": "derived.book_title",
      "category": "derived",
      "type": "string",
      "description": "Book title extracted from analysis (reformed-theology schema)",
      "descriptionZh": "从分析结果中提取的书名（改革宗神学模式）",
      "source": "analysis_result.meta.book_title",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "Knowing God"
    },
    {
      "name": "assumed_tradition",
      "fullName": "derived.assumed_tradition",
      "category": "derived",
      "type": "string",
      "description": "Assumed theological tradition (reformed-theology schema)",
      "descriptionZh": "假定的神学传统（改革宗神学模式）",
      "source": "analysis_result.meta.assumed_tradition",
      "stages": ["translation"],
      "example": "Reformed evangelical"
    },
    {
      "name": "bible_version",
      "fullName": "derived.bible_version",
      "category": "derived",
      "type": "string",
      "description": "Target Chinese Bible version for references",
      "descriptionZh": "圣经引用的目标中文版本",
      "source": "analysis_result.meta.target_chinese_bible_version",
      "stages": ["translation"],
      "example": "CUV"
    },
    {
      "name": "author_theological_identity",
      "fullName": "derived.author_theological_identity",
      "category": "derived",
      "type": "string",
      "description": "Author's theological identity (reformed-theology schema)",
      "descriptionZh": "作者的神学身份（改革宗神学模式）",
      "source": "analysis_result.author_biography.theological_identity",
      "stages": ["translation"],
      "example": "Reformed evangelical Anglican"
    },
    {
      "name": "author_historical_context",
      "fullName": "derived.author_historical_context",
      "category": "derived",
      "type": "string",
      "description": "Historical context of the author's writing",
      "descriptionZh": "作者写作的历史背景",
      "source": "analysis_result.author_biography.historical_context",
      "stages": ["translation"],
      "example": "Post-war British evangelicalism"
    },
    {
      "name": "author_influence",
      "fullName": "derived.author_influence",
      "category": "derived",
      "type": "string",
      "description": "How author background influences translation decisions",
      "descriptionZh": "作者背景如何影响翻译决策",
      "source": "analysis_result.author_biography.influence_on_translation",
      "stages": ["translation"],
      "example": "Emphasize doctrinal precision"
    },
    {
      "name": "bible_reference_policy",
      "fullName": "derived.bible_reference_policy",
      "category": "derived",
      "type": "string",
      "description": "Formatted Bible reference handling policy",
      "descriptionZh": "格式化的圣经引用处理策略",
      "source": "analysis_result.bible_reference_policy (formatted)",
      "stages": ["translation"],
      "example": "Use CUV for all Scripture references"
    },
    {
      "name": "sentence_splitting_rules",
      "fullName": "derived.sentence_splitting_rules",
      "category": "derived",
      "type": "string",
      "description": "Rules for splitting long sentences",
      "descriptionZh": "长句拆分规则",
      "source": "analysis_result.syntax_and_logic.sentence_splitting_rules",
      "stages": ["translation"],
      "example": "Split at conjunctions when exceeding 40 words"
    },
    {
      "name": "logical_connectors",
      "fullName": "derived.logical_connectors",
      "category": "derived",
      "type": "string",
      "description": "How to translate logical connectors",
      "descriptionZh": "逻辑连接词的翻译方式",
      "source": "analysis_result.syntax_and_logic.logical_connectors",
      "stages": ["translation"],
      "example": "Preserve explicit logical relationships"
    },
    {
      "name": "notes_allowed",
      "fullName": "derived.notes_allowed",
      "category": "derived",
      "type": "string",
      "description": "Types of notes allowed in translation",
      "descriptionZh": "翻译中允许添加的注释类型",
      "source": "analysis_result.notes_policy.allowed (formatted)",
      "stages": ["translation"],
      "example": "Translator notes for cultural context"
    },
    {
      "name": "notes_forbidden",
      "fullName": "derived.notes_forbidden",
      "category": "derived",
      "type": "string",
      "description": "Types of notes forbidden in translation",
      "descriptionZh": "翻译中禁止添加的注释类型",
      "source": "analysis_result.notes_policy.forbidden (formatted)",
      "stages": ["translation"],
      "example": "Personal opinions, theological commentary"
    },

    {
      "name": "word_count",
      "fullName": "meta.word_count",
      "category": "meta",
      "type": "number",
      "description": "Word count of the source text",
      "descriptionZh": "源文本的词数",
      "source": "computed",
      "stages": ["translation", "optimization"],
      "example": "156"
    },
    {
      "name": "char_count",
      "fullName": "meta.char_count",
      "category": "meta",
      "type": "number",
      "description": "Character count of the source text",
      "descriptionZh": "源文本的字符数",
      "source": "computed",
      "stages": ["translation", "optimization"],
      "example": "892"
    },
    {
      "name": "paragraph_index",
      "fullName": "meta.paragraph_index",
      "category": "meta",
      "type": "number",
      "description": "Index of current paragraph within chapter",
      "descriptionZh": "当前段落在章节中的索引",
      "source": "paragraph.order_index",
      "stages": ["translation", "proofreading"],
      "example": "5"
    },
    {
      "name": "chapter_index",
      "fullName": "meta.chapter_index",
      "category": "meta",
      "type": "number",
      "description": "Index of current chapter",
      "descriptionZh": "当前章节的索引",
      "source": "chapter.order_index",
      "stages": ["translation", "proofreading"],
      "example": "3"
    },
    {
      "name": "stage",
      "fullName": "meta.stage",
      "category": "meta",
      "type": "string",
      "description": "Current processing stage",
      "descriptionZh": "当前处理阶段",
      "source": "runtime",
      "stages": ["analysis", "translation", "optimization", "proofreading"],
      "example": "translation"
    },

    {
      "name": "glossary",
      "fullName": "user.glossary",
      "category": "user",
      "type": "object",
      "description": "Custom terminology glossary for the project",
      "descriptionZh": "项目的自定义术语表",
      "source": "project_variables.glossary",
      "stages": ["translation", "proofreading"],
      "example": "{\"covenant\": \"圣约\", \"redemption\": \"救赎\"}",
      "structure": "Record<string, string>"
    },
    {
      "name": "special_instructions",
      "fullName": "user.special_instructions",
      "category": "user",
      "type": "string",
      "description": "Special handling instructions for this project",
      "descriptionZh": "项目的特殊处理指令",
      "source": "project_variables.special_instructions",
      "stages": ["translation", "optimization", "proofreading"],
      "example": "This book contains many Puritan-era references..."
    },
    {
      "name": "macros",
      "fullName": "user.macros",
      "category": "user",
      "type": "object",
      "description": "Custom macro definitions for reuse",
      "descriptionZh": "可复用的自定义宏定义",
      "source": "project_variables.macros",
      "stages": ["analysis", "translation", "optimization", "proofreading"],
      "example": "{\"book_info\": \"{{project.title}}\"}",
      "structure": "Record<string, string>"
    }
  ],

  "aliases": {
    "source_text": "content.source",
    "writing_style": "derived.writing_style",
    "tone": "derived.tone",
    "terminology_table": "derived.terminology_table"
  },

  "defaultMacros": {
    "book_info": "{{project.title}} by {{project.author}}",
    "style_guide": "{{#if derived.writing_style}}**Style**: {{derived.writing_style}}\n{{/if}}{{#if derived.tone}}**Tone**: {{derived.tone}}{{/if}}",
    "terminology_section": "{{#if derived.has_terminology}}### Terminology\n{{derived.terminology_table}}{{/if}}"
  },

  "templateSyntax": {
    "variable": "{{var}} or {{namespace.var}}",
    "fallback": "{{var | default:\"fallback value\"}}",
    "conditional": "{{#if var}}...{{/if}}",
    "conditionalElse": "{{#if var}}...{{#else}}...{{/if}}",
    "conditionalAnd": "{{#if var1 && var2}}...{{/if}}",
    "conditionalAndElse": "{{#if var1 && var2}}...{{#else}}...{{/if}}",
    "conditionalOr": "{{#if var1 || var2}}...{{/if}}",
    "conditionalOrElse": "{{#if var1 || var2}}...{{#else}}...{{/if}}",
    "unless": "{{#unless var}}...{{/unless}}",
    "loop": "{{#each array}}{{this}}{{/each}}",
    "loopWithIndex": "{{#each array}}{{@index}}: {{this}}{{/each}}",
    "loopDict": "{{#each dict}}{{@key}}: {{this}}{{/each}}",
    "macro": "{{@macro_name}}",
    "typeFormat": "{{var:type}} where type is list, table, terminology, json, inline"
  },

  "typeFormats": {
    "list": "Bullet points list",
    "table": "Markdown table format",
    "terminology": "Term: translation format",
    "json": "Pretty-printed JSON",
    "inline": "Comma-separated values"
  }
}
